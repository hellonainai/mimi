<template>
    <div class="kem-table__body">
        <div v-if="headerPermission" v-loading="loading" class="header_body">
            <div v-if="headerTopPermission" class="header__body-top">
                <slot name="menuTop"></slot>

            </div>
            <div v-if="headerCenterPermission" class="header__body-center">
                <div class="header__body-left">
                    <slot name="menuLeft"></slot>
                </div>
                <div class="header__body-right">
                    <slot name="menuRight"></slot>
                    <KemButton v-if="menuPermissionAdd" @click="clickMenuButton({type:'add'})">新增</KemButton>
                </div>
            </div>
            <div v-if="headerBottomPermission" class="header__body-bottom">
                <div v-if="headerSearchPermission">
                    <!--表格默认的搜索组件 -->
                    <KemSearch v-model="searchForm" v-bind="searchProps" />
                </div>
                <div>
                    <slot name="menuBottom"></slot>
                </div>
            </div>

        </div>


        <avue-crud
                ref="crud"
                v-model="obj"
                :data="crudData"
                :option="computedOption"
                :page="page"
                :table-loading="loading"
                :search-solt="true"
                :row-style="methodsRowStyle"
                @size-change="sizeChange"
                @current-change="currentChange"
                @sort-change="sortChange"
                @row-update="rowUpdate"
                @row-click="rowClick"
                @cell-click="cellClick"
                @tree-load="treeLoad"
                @expand-change="expandChanges"
        >

            <template
                    v-for="(item,key) in column"
                    :slot="item.prop"
                    slot-scope="scope"
            >
                <render-content
                        v-if="item.render"
                        :key="key"
                        :render="item.render"
                        :scope="scope"
                        :column="item"
                ></render-content>
                <slot :name="item.prop" :scope="scope"></slot>
            </template>

            <!-- <template slot="menuLeft">
                 <slot name="menuLeft"></slot>
             </template>
             <template slot="menuRight">
                 <slot name="menuRight"></slot>
                 <KemButton v-if="menuPermissionAdd" @click="clickMenuButton({type:'add'})">新增</KemButton>
             </template>-->

            <template v-if="!loading" slot="expand" slot-scope="scope">
                <slot
                        name="expand"
                        :scope="scope"
                />
            </template>

            <template v-if="!loading" slot="menu" slot-scope="scope">
                <KemButton
                        v-if="menuPermissionDetail"
                        :type="`${menuButtonType}.detail`"
                        @click="clickMenuButton({row:scope.row,type:'detail'})"
                />
                <KemButton v-if="menuPermissionEdit"
                           :type="`${menuButtonType}.edit`"
                           @click="clickMenuButton({row:scope.row,type:'edit'})"
                ></KemButton>


                <KemButton
                        v-if="menuPermissionDel"
                        :type="`${menuButtonType}.del`"
                        @click="clickMenuButton({row:scope.row,type:'del'})"
                />

                <slot
                        name="menu"
                        :scope="scope"
                />
            </template>


        </avue-crud>
    </div>
</template>

<script lang="jsx">

import { cloneDeep ,debounce} from 'lodash'

const defaultPage = {
    pageSizes: [5, 10, 20, 50],
    currentPage: 1,
    total: 0,
    pageSize: 20
};

// 表格字段格式化
const RenderContent = {
    props: {
        render: Function,
        scope: Object,
        column: Object,

    },
    render (h) {
        const { row } = this.scope
        const { prop } = this.column
        const params = {
            column:this.column,
            row:row,
            value:row[prop]

        }


        if (this.render) {
            return this.render(h, params)
        }

        return <el-tag>{row[prop]}</el-tag>
    }
}
/**
 * @displayName Table 配置化表格
 */
export default {
    name: 'KemTable',
    components:{
        RenderContent
    },
    props: {

        readOnly:{
            type:Boolean,
            default:false
        },


        tableData: {
            type: Array,
            default:()=>{
                return []
            }
        },

        column: {
            type: Array,
            default:()=>{
                return []
            }
        },


        /**
         * sizie尺寸
         * medium| small| mini
         */
        size:{
            type: String,
            default:'small'
        },

        /**
         * 字体位置
         * medium| small| mini
         */
        align:{
            type: String,
            default:'center'
        },

        /**
         * 行展开
         */
        expand:{
            type:Boolean,
            default:false
        },

        /**
         * 分页器
         */
        pageOption: {
            type: Object,
            default:()=>{
                return{
                    pageSizes: [5, 10, 20, 50],
                    pageSize: 20
                }
            }
        },
        /**
         * 操作栏宽度
         * width| small| mini
         */
        menuWidth: {
            type:Number,
            default:200
        },
        menuButton:{
            type:Array,
            default:()=>{
                return[]
            }
        },
        /**
         * 是否显示分页器
         */
        isShowPage:{
            type:Boolean,
            default:true
        },

        /**
         * 是否显示边框
         */
        isShowBorder:{
            type:Boolean,
            default:true
        },

        /**
         * 是否显示斑马线
         */
        isShowStripe:{
            type:Boolean,
            default:true
        },
        /**
         * 是否显示索引
         */
        isShowIndex:{
            type:Boolean,
            default:true
        },
        /**
         * 是否显示表头
         */
        isShowHeader:{
            type:Boolean,
            default:true
        },


        /**
         * 默认参数
         */
        defaultParams: {
            type: Object,
            default:()=>{
                return{

                }
            }
        },
        /**
         * 参数转义
         */
        defaultProps: {
            type: Object,
            default:()=>{
                return{
                    currentPage: 'pageNo',
                    pageSize: 'pageSize',
                    order: 'order',
                    prop: 'prop',
                    total: 'page_size',

                }
            }
        },
        /**
         * 异步方法
         */
        // eslint-disable-next-line vue/require-default-prop
        request:Function,
        /**
         * 结果处理
         */
        // eslint-disable-next-line vue/require-default-prop
         result:Function,
        /**
         * 行样式
         */
        // eslint-disable-next-line vue/require-default-prop
        rowStyle:Function,

        treeLoad:{
            type:Function,
            default:()=>{
                return{}
            }
        },

        // eslint-disable-next-line vue/require-default-prop
        tableHeight:{
            type:Number,
        },

        /**
         * 菜单按钮滴样式
         */
        menuButtonType:{
            type:String,
            default:'text'

        },

        /**
         * 单元格超出隐藏
         */
        columnOverHidden:{
            type:Boolean,
            default:true

        },

        /**
         * rowkey
         */
        rowKey:{
            type:String,
            default:'$index'

        },
        /**
         * 搜索框的传值
         */
        searchProps: {
            type: [Object,Boolean],
            default:false
        },

        /**
         * 树的传值
         */
        treeProps: {
            type: [Object,Boolean],
            default:false
        },

    },

    data() {
        return {
            searchForm:{},
            crudData:[],
            // 分页器
            page: {
                //总条数,如果为0的话不显示分页
                total:1
            },
            obj:{},
            sort: {},
            loading:false,
            expandRowKeys:[]


        }
    },

    computed: {
        computedOption(){

            const lazy = this.treeProps.lazy || false
            let option = {
                indexLabel:'序号',

                page:false,
                delBtn:false,
                addBtn:false,
                editBtn:false,
                refreshBtn:false,
                columnBtn:false,
                height:this.tableHeight,
                index:this.isShowIndex,
                showHeader:this.isShowHeader,
                size:this.size,
                align:this.align,
                menuAlign:this.align,
                border:this.isShowBorder,
                stripe:this.isShowStripe,
                menuWidth:this.menuWidth,
                rowKey:this.rowKey,
                expandRowKeys:this.expandRowKeys,
                expand: this.expand,
                lazy: lazy,

            }

            if (this.isShowPage){
                option.page = true
            }
            const header = !!(this.$scopedSlots.menuLeft || this.$scopedSlots.menuRight) || this.menuPermissionAdd;

            const menu = !!(this.$scopedSlots.menu )|| this.menuPermissionDel || this.menuPermissionEdit || this.menuPermissionDetail

            const column = this.column.map((item)=>{

                if(this.columnOverHidden){
                    item = {
                        overHidden:true,
                        ...item
                    }
                }
                return  item
            })



            return{
                ...option,
                header,
                menu,
                column
            }
        },
        queryParams(){


            return{
                ...this.defaultParams,
                ...this.searchForm,
            }
        },


        menuPermissionDetail() {
            return  this.menuPermission(['detailBtn','allBtn'])
        },

        menuPermissionDel() {
            return  this.menuPermission(['delBtn','allBtn'])
        },

        menuPermissionAdd() {
            return  this.menuPermission(['addBtn','allBtn'])
        },

        menuPermissionEdit() {
            return  this.menuPermission(['editBtn','allBtn'])
        },

        headerTopPermission() {
            return  !!(this.$scopedSlots.menuTop)
        },

        headerCenterPermission() {
            return  !!(this.$scopedSlots.menuLeft || this.$scopedSlots.menuRight|| this.menuPermissionAdd)
        },

        headerBottomPermission() {
            return  !!(this.$scopedSlots.menuBottom || this.headerSearchPermission)
        },

        headerSearchPermission() {
            return  !!this.searchProps
        },

        headerPermission() {
            return  !!( this.headerTopPermission ||this.headerCenterPermission ||this.headerBottomPermission || this.menuPermissionAdd )
        },


    },



    watch: {
        /**
         * 搜索条件改变了
         */
        searchForm:{
            handler(value) {
                this.$emit('searchFormUpdata',value)
            },
            deep: true
        },
        tableData:{
            handler() {
                this.getListData()
            },
            deep: true
        },
        defaultParams: {
            handler() {

                this.refreshDefaultParams()
            },
            deep: true
        },
        queryParams: {
            handler() {

                this.refreshDefaultParams()
            },
            deep: true
        },
        column: {
            handler() {

                this.renderTable()
            },
            deep: true
        },
    },

    created() {

        this.renderTable()
    },
    methods: {
        /**
         * 判断权限
         */
        menuPermission(value){

            const menuButton = this.menuButton

            return value.some(r=> menuButton.includes(r)>0)


        },

        refreshDefaultParams:debounce(function() {
            this.resetPage()
            this.getListData()

        },500),



        async getListData(params={}){

            try {
                const queryParams = this.queryParams


                const { currentPage , pageSize } = this.page

                const { order , prop } = this.sort

                const request = this.request



                if(request){

                    this.loading = true
                    try {
                        const res = await request({
                            [this.defaultProps['currentPage']] :currentPage,
                            [this.defaultProps['pageSize']] :pageSize,
                            [this.defaultProps['order']] :order,
                            [this.defaultProps['prop']] :prop,
                            ...queryParams,
                            ...params
                        })

                        let data = res

                        const  result  = this.result

                        if(result){

                            data  = await result(res) || []

                        }

                        this.loading=false

                        this.page.total =  res[this.defaultProps['total']]

                        this.crudData = data
                    } catch (error) {

                        this.loading=false

                        throw new Error(error)

                    }

                }
                else {

                    if (this.treeProps) {
                        const {loop} = this.treeProps || false

                        if(loop){

                            this.crudData = this.getTree(this.tableData,'')



                        }else {
                             this.crudData = this.tableData

                        }
                    }
                    else {
                        this.crudData = this.tableData

                        console.log(this.crudData)

                    }


                }
            }catch {
                this.crudData = []
            }



        },
        /**
         * 表格渲染
         */
        renderTable(){
            this.resetPage()

            this.getListData()

        },
        /**
         * 重置分页器分页器
         */
        resetPage(){

            this.page = {
                ...cloneDeep(defaultPage),
                ...cloneDeep(this.pageOption)

            }

        },

        /**
         * 分页器每页条数改变
         */
        sizeChange(val) {

            this.page.currentPage = 1
            this.page.pageSize = val
            this.getListData()
        },

        /**
         * 当前页数改变
         */
        currentChange(val) {
            this.page.currentPage = val
            this.getListData()
        },

        /**
         * 排序
         */
        sortChange(val) {
            const { order,prop } = val
            this.sort.order = order
            this.sort.prop = prop
            this.getListData()
        },
        /**
         * 列展开手风琴
         */
        expandChanges(row, expendList) {
            if (this.treeProps) return

            if (expendList.length) {
                this.expandRowKeys = []
                if (row) {
                    this.expandRowKeys.push(row.$index)
                }
            } else {
                this.expandRowKeys = []
            }
            this.$emit('expandChanges',{row, expendList})
        },


        /**
         * 递归拼装树参数
         */
        getTree(treeData,pid,){

            if(!this.treeProps['pid']) this.treeProps['pid'] = 'pid'
            if(!this.treeProps['id']) this.treeProps['id'] = 'id'
            let treeArr=[];
            for(let i=0;i<treeData.length;i++){
                let node=treeData[i];
                if(node[this.treeProps['pid']] === pid ){
                    let newNode={
                        ...node,
                        children:this.getTree(treeData,node[this.treeProps['id']])
                    };
                    treeArr.push(newNode);
                }
            }
            return treeArr;
        },

        // 表格增加一行
        rowCellAdd(row){
            this.$refs.crud.rowCellAdd(row);
        },

        // 当行内编辑点击保存时
        rowUpdate(form,index,done,loading){
            loading()
            done()
            this.$emit('rowUpdate',this.crudData,{form,index,done,loading})
        },

        // 当某个单元格被点击时会触发该事件
        cellClick(	row, column, cell, event){
            this.$emit('cellClick',{
                row, column, cell, event
            })
        },

        // 当某一行被点击时会触发该事件
        rowClick(row,event,column){
            this.$emit('rowClick',{
                row, column, event
            })

        },

        // 单元格样式
        methodsRowStyle({rowIndex,row} ){
            const basestyles = ({rowIndex})=>{
                if(rowIndex%2===0){

                    return {
                        backgroundColor:'#f7f7f7',
                    }
                }
            }
            const rowStyle = this.rowStyle || basestyles

            return rowStyle({rowIndex,row})

        },

        // 点击操作栏的删除按钮
        clickMenuButton(value){

            const {type} = value
            if(type ==='del'){
                this.$confirm('此操作将永久删除该条记录, 是否继续?', '删除', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    this.$emit('clickMenuButton',{...value})
                })
            }else {
                this.$emit('clickMenuButton',{...value})
            }

        },


        // 代码调用懒加载
        loadOrToggle(row){


             this.$refs.crud.$refs.table.store.loadOrToggle(row)

        }

    }

}



</script>

<style lang='scss'>
.kem-table__body{
    overflow: auto;
    .avue-crud{
        .avue-crud__menu{display: none}
        .el-table{
            border: 1px solid #d9ecff !important;
            border-bottom: 0px solid #d9ecff !important;

        }
        .el-table--striped .el-table__body tr.el-table__row--striped td{
            background-color: inherit;

        }
        width: 98%!important;
        .el-card{
            // border: 0;
            .el-card__body{
                padding: 10px 0;
                .avue-crud__header{
                    margin-bottom: 0;
                }
                .avue-crud__menu{
                    height: auto;
                    min-height: 0;
                    // margin-bottom: 0;
                    display: flex;
                    justify-content: space-between;
                    .avue-crud__left, .avue-crud__right{
                        overflow: auto;
                        position: inherit;
                        >button{
                            margin-bottom: 5px;
                        }
                    }


                }
            }
            .avue-crud__tip{
                display: none;
            }


            .my-tag{
                background-color: #ecf5ff;
                display: inline-block;
                height: 32px;
                padding: 0 10px;
                line-height: 30px;
                font-size: 12px;
                color: #409eff;
                border: 1px solid #d9ecff;
                border-radius: 4px;
                box-sizing: border-box;
                white-space: nowrap;
                margin: 3px 0;
            }


        }
    }
    .header_body{
        padding: 0 1%;
        margin-bottom: 15px;
        .header__body-top{
            margin-bottom: 15px;

        }
        .header__body-center{
            width: 100%;
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;

            .header__body-left{
                width: 49%;
                text-align: left;
            }
            .header__body-right{
                width: 49%;
                text-align: right;
            }
        }
        .header__body-bottom{

        }
    }
}

</style>

